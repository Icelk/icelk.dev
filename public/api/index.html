!> tmpl standard.html markdown.html
$[head]
    <title>API reference | Icelk</title>
    <meta name="permalinks" content="enabled"> <!-- part of JS on icelk.dev & kvarn.org, options: disabled|enabled|not-titles -->
    <meta name="description" content="Documentation for APIs available for free on icelk.dev">
$[dependencies]$[md-imports]$[close-head]$[navigation]
<main><md><p>This a document containing the usage of all the APIs I offer, for free. Always.</p>
<p>I will never store identifiable data, such as IP addresses, <code>user-agent</code> strings, etc.</p>
<p>The structure is as follows:</p>
<ul>
<li>first heading level denotes the category.</li>
<li>the next heading level is the name of the API (optional, e.g. <a href="#ip">IP</a> doesn’t need this)</li>
<li>the next is the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods">HTTP method</a> used
can be multiple per API.</li>
<li>the next level is metadata about the API.</li>
</ul>
<p>All error responses contain a <code>reason</code> header and a useful body.
See the first example of the <a href="#lookup">lookup API</a>.</p>
<table id="toc"><thead><tr><th>Contents</th></tr></thead><tbody>
<tr><td><a href="#ip">1 IP</a></td></tr>
<tr><td><span style="margin-left: 2em"></span><a href="#get">1.1 GET</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#description">1.1.1 Description</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#query">1.1.2 Query</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#response">1.1.3 Response</a></td></tr>
<tr><td><a href="#dns">2 DNS</a></td></tr>
<tr><td><span style="margin-left: 2em"></span><a href="#lookup">2.2 Lookup</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#get-1">2.2.1 GET</a></td></tr>
<tr><td><span style="margin-left: 6em"></span><a href="#description-1">2.2.1.1 Description</a></td></tr>
<tr><td><span style="margin-left: 6em"></span><a href="#query-1">2.2.1.2 Query</a></td></tr>
<tr><td><span style="margin-left: 6em"></span><a href="#response-1">2.2.1.3 Response</a></td></tr>
<tr><td><span style="margin-left: 6em"></span><a href="#examples">2.2.1.4 Examples</a></td></tr>
<tr><td><span style="margin-left: 2em"></span><a href="#dns-over-tls-check">2.3 DNS over TLS check</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#get-1-1">2.3.2 GET</a></td></tr>
<tr><td><span style="margin-left: 6em"></span><a href="#description-1-1">2.3.2.1 Description</a></td></tr>
<tr><td><span style="margin-left: 6em"></span><a href="#query-1-1">2.3.2.2 Query</a></td></tr>
<tr><td><span style="margin-left: 6em"></span><a href="#response-1-1">2.3.2.3 Response</a></td></tr>
<tr><td><span style="margin-left: 6em"></span><a href="#examples-1">2.3.2.4 Examples</a></td></tr>
<tr><td><a href="#search">3 Search</a></td></tr>
<tr><td><span style="margin-left: 2em"></span><a href="#get-1-1-1">3.4 GET</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#description-1-1-1">3.4.3 Description</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#query-1-1-1">3.4.4 Query</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#response-1-1-1">3.4.5 Response</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#examples-1-1">3.4.6 Examples</a></td></tr>
<tr><td><a href="#websocket-ping-pong">4 WebSocket ping pong</a></td></tr>
<tr><td><span style="margin-left: 2em"></span><a href="#upgrade-to-websocket">4.5 UPGRADE to `websocket`</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#description-1-1-1-1">4.5.1 Description</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#response-1-1-1-1">4.5.2 Response</a></td></tr>
<tr><td><a href="#auth">5 AUTH</a></td></tr>
<tr><td><span style="margin-left: 2em"></span><a href="#put--post">5.6 PUT & POST</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#description-1-1-1-1-1">5.6.1 Description</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#response-1-1-1-1-1">5.6.2 Response</a></td></tr>
<tr><td><span style="margin-left: 2em"></span><a href="#delete">5.7 DELETE</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#description-1-1-1-1-1-1">5.7.1 Description</a></td></tr>
<tr><td><span style="margin-left: 4em"></span><a href="#response-1-1-1-1-1-1">5.7.2 Response</a></td></tr>
</tbody></table>
<h1 id="ip">IP</h1>
<p><code>/ip</code></p>
<h2 id="get">GET</h2>
<h3 id="description">Description</h3>
<p>Returns the IP address of the callee.</p>
<h3 id="query">Query</h3>
<p>No query parameters are considered.</p>
<h3 id="response">Response</h3>
<p>The IP address in plain text.</p>
<h1 id="dns">DNS</h1>
<h2 id="lookup">Lookup</h2>
<p><code>/dns/lookup</code></p>
<h3 id="get-1">GET</h3>
<h4 id="description-1">Description</h4>
<p>Resolve the A, AAAA, MX, TXT, and CNAME records for a domain.</p>
<p>Uses <a href="/dns/">my public resolver</a>.</p>
<h4 id="query-1">Query</h4>
<ul>
<li><code>domain</code> (required) - gives the domain of which to operate on</li>
</ul>
<h4 id="response-1">Response</h4>
<p>Each DNS record is on it’s own line (separated by <code>\n</code>, not <code>\r\n</code>)
with the type followed by one space followed by the value.</p>
<p>Will always contain a trailing “\n”.</p>
<p>The value is the string of the destination domain in the case of MX &amp; CNAME,
the IP address in the case of A &amp; AAAA
and the content in case of a TXT.</p>
<p>If the domain can’t be resolved, a 404 will be returned.</p>
<h4 id="examples">Examples</h4>
<pre style="background-color:#2d2d2d;"><code class="language-shell"><span style="color:#6699cc;">$</span><span style="color:#d3d0c8;"> curl</span><span style="color:#f2777a;"> -sI </span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">https://icelk.dev/dns/lookup?domain=icelk.dev.dev</span><span style="color:#d3d0c8;">&quot; | </span><span style="color:#6699cc;">grep </span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">reason: </span><span style="color:#d3d0c8;">&quot;
</span><span style="color:#6699cc;">reason:</span><span style="color:#d3d0c8;"> no DNS entry was found
</span></code></pre>
<p>I intentionally added a newline at the bottom to reflect the API.
This isn’t how it’s displayed in a shell, but represents the string you’d get from a programming language HTTP request function.</p>
<pre style="background-color:#2d2d2d;"><code class="language-shell"><span style="color:#6699cc;">$</span><span style="color:#d3d0c8;"> curl &quot;</span><span style="color:#99cc99;">https://icelk.dev/dns/lookup?domain=icelk.dev</span><span style="color:#d3d0c8;">&quot;
</span><span style="color:#6699cc;">A</span><span style="color:#d3d0c8;"> 78.69.142.191
</span><span style="color:#6699cc;">MX</span><span style="color:#d3d0c8;"> mail.icelk.dev.

</span></code></pre><h2 id="dns-over-tls-check">DNS over TLS check</h2>
<p><code>/dns/check-dns-over-tls</code></p>
<h3 id="get-1-1">GET</h3>
<h4 id="description-1-1">Description</h4>
<p>Checks the DNS server at the IP address for DNS over TLS support for the domain.</p>
<h4 id="query-1-1">Query</h4>
<ul>
<li><code>ip</code> (required) - the IP address for the DNS server</li>
<li><code>name</code> (required) - the domain to check the certificate against</li>
<li><code>lookup-name</code> (default: <code>icelk.dev</code>) - which domain to resolve. This should not matter.</li>
</ul>
<h4 id="response-1-1">Response</h4>
<p>Might return a <code>500 Internal Server Error</code> if creating a DNS request failed.</p>
<p>If the server failed to respond before the timeout,
used an invalid protocol, or
failed the TLS check, the string <code>unsupported</code> is returned.</p>
<p>If everything checks out, <code>supported</code> is returned.</p>
<h4 id="examples-1">Examples</h4>
<pre style="background-color:#2d2d2d;"><code class="language-shell"><span style="color:#6699cc;">$</span><span style="color:#d3d0c8;"> curl &quot;</span><span style="color:#99cc99;">https://icelk.dev/dns/check-dns-over-tls?ip=78.69.142.191&amp;name=icelk.dev</span><span style="color:#d3d0c8;">&quot;
</span><span style="color:#6699cc;">supported
</span></code></pre><h1 id="search">Search</h1>
<p><code>/search</code></p>
<h2 id="get-1-1-1">GET</h2>
<h3 id="description-1-1-1">Description</h3>
<p>Returns matches of <code>q</code> on the text of <a href="https://icelk.dev">icelk.dev</a>.</p>
<h3 id="query-1-1-1">Query</h3>
<ul>
<li><code>q</code> (required) - the query to look up.</li>
</ul>
<p>The query format has the following rules (roughly).</p>
<ul>
<li>Spaces and hyphens (<code>-</code>) are treated as AND.</li>
<li>The literals AND, OR, NOT correspond accordingly. They are case-insensitive.</li>
<li><code>-</code> and <code>!</code> are NOT.</li>
<li>Parentheses can group items together.</li>
<li>NOT must be next to an AND (“this and not that”)</li>
<li>All text segments are case-insensitive.</li>
<li>All test segments discard any non-alphanumerical characters.</li>
</ul>
<p><code>icelk -(kvarn or agde)</code> =&gt; “icelk and not (kvarn or agde)”
<code>(icelk or 10x-dev) (kvarn -agde)</code> =&gt; (icelk or (10x and dev)) and (kvarn and not agde)</p>
<h3 id="response-1-1-1">Response</h3>
<p>A list of hits in JSON.</p>
<p>The scheme is described below.</p>
<pre style="background-color:#2d2d2d;"><code class="language-json"><span style="color:#d3d0c8;">[
    {
        &quot;</span><span style="color:#99cc99;">rating</span><span style="color:#d3d0c8;">&quot;: number, </span><span style="color:#747369;">// the rating of the hit. All the output is sorted according to this.
        </span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">path</span><span style="color:#d3d0c8;">&quot;: string, </span><span style="color:#747369;">// the path to the document which contains the hit.
        </span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">start</span><span style="color:#d3d0c8;">&quot;: number, </span><span style="color:#747369;">// the byte at which the hit starts, mostly unimportant, as a different representation to the HTML is used when querying.
        </span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">associated_occurrences</span><span style="color:#d3d0c8;">&quot;: number[], </span><span style="color:#747369;">// starts of other occurrences which are required for this query. Mostly unimportant for the same reasons as `start`.
        </span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">context</span><span style="color:#d3d0c8;">&quot;: string, </span><span style="color:#747369;">// the surrounding text of the hit
        </span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">context_start_chars</span><span style="color:#d3d0c8;">&quot;: number, </span><span style="color:#747369;">// number of bytes in `context` before hit.
        </span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">context_start_bytes</span><span style="color:#d3d0c8;">&quot;: number, </span><span style="color:#747369;">// same as above, but with bytes instead. `context.get(context_start_bytes..)` is guaranteed to split on a valid UTF-8 codepoint. Though, don't trust a external web API!
    </span><span style="color:#d3d0c8;">}
]
</span></code></pre><h3 id="examples-1-1">Examples</h3>
<p>Here, everything is on the same line in the web response, but I’ve taken the freedom to remove all but the highest rated hit (by far) and use <code>...</code> to signal all other.</p>
<pre style="background-color:#2d2d2d;"><code class="language-shell"><span style="color:#6699cc;">$</span><span style="color:#d3d0c8;"> curl &quot;</span><span style="color:#99cc99;">https://icelk.dev/search?q=next%20gen</span><span style="color:#d3d0c8;">&quot;
</span><span style="color:#66cccc;">[
</span><span style="color:#6699cc;">{</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">start</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#6699cc;">:18,</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">rating</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#6699cc;">:9.523809,</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">path</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#6699cc;">:</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">/kvarn/index.html</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#6699cc;">,</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">context</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#6699cc;">:</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">Kvarn\n\nKvarn is a next-generation web server designed for performanc</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#6699cc;">,</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">context_start_bytes</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#6699cc;">:18,</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">context_start_chars</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#6699cc;">:18,</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#99cc99;">associated_occurrences</span><span style="color:#d3d0c8;">&quot;</span><span style="color:#6699cc;">:[18,23]</span><span style="color:#d3d0c8;">}</span><span style="color:#6699cc;">,
...
]
</span></code></pre><h1 id="websocket-ping-pong">WebSocket ping pong</h1>
<p><code>/ws-ping</code></p>
<h2 id="upgrade-to-websocket">UPGRADE to <code>websocket</code></h2>
<h3 id="description-1-1-1-1">Description</h3>
<p>A WebSocket endpoint which immediately responds with every incoming message.</p>
<p>This is a test for the Kvarn WebSocket support, and may be terminated at any time.</p>
<h3 id="response-1-1-1-1">Response</h3>
<p>A <code>101 Switching Protocols</code> and a WebSocket conversation.</p>
<h1 id="auth">AUTH</h1>
<p><code>/admin/auth</code></p>
<p>Powered by <a href="https://github.com/Icelk/kvarn-auth"><code>kvarn-auth</code></a>.
See it’s <a href="https://doc.icelk.dev/kvarn-auth/kvarn_auth/">docs</a> for more details.</p>
<h2 id="put--post">PUT &amp; POST</h2>
<h3 id="description-1-1-1-1-1">Description</h3>
<p>An authentication route which gives you access to <code>/admin</code>.</p>
<p>I encourage you to try to crack the authentication.</p>
<h3 id="response-1-1-1-1-1">Response</h3>
<p>A response with an appropriate status code. If the login was successful, the cookies <code>auth-jwt</code> and <code>auth-credentials</code> are set using a <code>set-cookie</code> header.</p>
<h2 id="delete">DELETE</h2>
<h3 id="description-1-1-1-1-1-1">Description</h3>
<p>Log out from the authentication.</p>
<h3 id="response-1-1-1-1-1-1">Response</h3>
<p>A <code>200 OK</code> response which clears the auth cookies.</p>
</md></main>
$[footer]
